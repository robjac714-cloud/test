<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reelly Chat Bot (Pro)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;--panel:#fff;--stroke:#e5e7eb;--muted:#6b7280;--text:#111827;
      --a:#2563eb;--a2:#0ea5e9;--bot:#eef2ff;--user:#ecfeff;--warn:#fff7ed;
      --shadow:0 16px 40px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Tahoma;
      display:flex; justify-content:center; padding:16px;
    }
    .app{
      width:min(1040px,100%); height:min(92vh,940px);
      background:var(--panel); border:1px solid var(--stroke);
      border-radius:18px; overflow:hidden; box-shadow:var(--shadow);
      display:flex; flex-direction:column;
    }
    .top{
      padding:12px 14px; border-bottom:1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:linear-gradient(90deg,#fff,#f9fafb);
    }
    .brand{display:flex; gap:10px; align-items:center}
    .pill{
      width:34px; height:34px; border-radius:999px;
      background:radial-gradient(circle at 30% 30%,var(--a2),var(--a));
      color:#fff; display:grid; place-items:center; font-weight:900;
    }
    .brand .t1{font-weight:900}
    .brand .t2{font-size:12px; color:var(--muted); font-weight:700}
    .btn{
      border:1px solid var(--stroke); background:#fff; border-radius:999px;
      padding:8px 12px; cursor:pointer; font-weight:900; font-size:12px;
    }
    .btn.primary{
      border:0; color:#fff;
      background:linear-gradient(90deg,var(--a),var(--a2));
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }
    .chat{
      flex:1; overflow:auto; padding:14px;
      background:radial-gradient(circle at top, rgba(209,213,219,.55) 0, rgba(245,245,247,1) 60%);
    }
    .row{display:flex; margin:10px 0}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:min(78%,820px);
      border:1px solid var(--stroke);
      border-radius:16px; padding:10px 12px;
      font-size:14px; line-height:1.7;
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      white-space:pre-wrap;
    }
    .row.bot .bubble{background:var(--bot); border-top-right-radius:6px}
    .row.user .bubble{background:var(--user); border-top-left-radius:6px}
    .bubble.warn{background:var(--warn)}
    .bubble.debug{background:#0b1220;color:#e5e7eb;border-color:#111827;font-size:12px}
    .composer{
      border-top:1px solid var(--stroke);
      padding:12px; display:flex; gap:10px; background:#fff;
    }
    input{
      flex:1; border:1px solid #d1d5db; border-radius:12px;
      padding:12px; font-size:14px; outline:none;
    }
    input:focus{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.12);}
    .send{
      border:0; border-radius:12px; padding:12px 16px;
      font-weight:900; cursor:pointer; color:#fff;
      background:linear-gradient(90deg,var(--a),var(--a2));
    }

    /* Cards inside bot bubble */
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(230px,1fr));
      gap:12px;
      margin-top:10px;
    }
    .card{
      background:#fff; border:1px solid var(--stroke);
      border-radius:14px; overflow:hidden;
      box-shadow:0 10px 25px rgba(15,23,42,.06);
    }
    .card img{width:100%; aspect-ratio:16/10; object-fit:cover; background:#e5e7eb;}
    .cb{padding:10px 12px 12px}
    .ct{font-weight:900; margin-bottom:6px; font-size:14px}
    .meta{display:flex; flex-wrap:wrap; gap:6px; color:#374151; font-size:12px}
    .tag{background:#f3f4f6;border:1px solid var(--stroke);padding:3px 8px;border-radius:999px;font-weight:800}
    .link{
      display:block; margin-top:10px; text-align:center;
      border:1px solid #d1d5db; background:#f9fafb;
      border-radius:999px; padding:8px 10px;
      text-decoration:none; color:#2563eb; font-weight:900; font-size:13px;
    }

    /* Quick reply buttons */
    .quick{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .qbtn{
      border:1px solid #d1d5db; background:#fff; color:#111827;
      border-radius:999px; padding:8px 10px; cursor:pointer;
      font-weight:900; font-size:12px;
      box-shadow:0 1px 2px rgba(15,23,42,.04);
    }
  </style>
</head>

<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="pill">RB</div>
      <div>
        <div class="t1">Reelly Chat Bot</div>
        <div class="t2">Fallback Ø°ÙƒÙŠ + Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© + Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</div>
      </div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      <button class="btn primary" id="exampleBtn">Ù…Ø«Ø§Ù„</button>
    </div>
  </div>

  <div class="chat" id="chat"></div>

  <div class="composer">
    <input id="input" placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‚Ø© ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„ÙˆÙ† Ø¨Ø¯Ø¨ÙŠ Ù…Ø§Ø±ÙŠÙ†Ø§ Ø¨ÙŠÙ† 1 Ùˆ 2 Ù…Ù„ÙŠÙˆÙ†">
    <button class="send" id="sendBtn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
/* =========================
   âœ… CONFIG
========================= */
const API_BASE = "https://search-listings-production.up.railway.app/v1/properties";
const API_KEY  = "PUT_YOUR_REELLY_KEY_HERE"; // ğŸ”´ Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ
const API_KEY_HEADER = "X-API-Key";

/* Toggle debug bubbles (true/false) */
const DEBUG_ON = false;

/* =========================
   UI
========================= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");

function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }

function bubble(text, who, cls=""){
  const row = document.createElement("div");
  row.className = "row " + who;
  const b = document.createElement("div");
  b.className = "bubble" + (cls ? (" " + cls) : "");
  b.textContent = text;
  row.appendChild(b);
  chat.appendChild(row);
  scrollBottom();
  return b;
}
const bot  = (t)=>bubble(t,"bot");
const user = (t)=>bubble(t,"user");
const warn = (t)=>bubble(t,"bot","warn");
const dbg  = (t)=>{ if(DEBUG_ON) bubble(t,"bot","debug"); };

function tryParseJSON(s){ try{ return JSON.parse(s);}catch{ return null; } }
function isImg(u){ return typeof u==="string" && /^https?:\/\//.test(u); }
function getImage(it){
  if(typeof it.cover_image_url === "string"){
    const p = tryParseJSON(it.cover_image_url);
    if(p?.url) return p.url;
    if(isImg(it.cover_image_url)) return it.cover_image_url;
  }
  return "https://dummyimage.com/900x506/e5e7eb/111827&text=No+Image";
}
function getCoords(it){
  if(typeof it.coordinates==="string"){
    const parts = it.coordinates.split(",").map(v=>Number(v.trim()));
    if(parts.length>=2 && parts.every(Number.isFinite)) return {lat:parts[0], lng:parts[1]};
  }
  return null;
}

function tagEl(text){
  const s = document.createElement("span");
  s.className = "tag";
  s.textContent = text;
  return s;
}

function renderCardsInBot(items, titleText="Ø£ÙØ¶Ù„ 5 Ù†ØªØ§Ø¦Ø¬ ğŸ‘‡"){
  bot(titleText);

  const row = document.createElement("div");
  row.className = "row bot";

  const b = document.createElement("div");
  b.className = "bubble";

  const grid = document.createElement("div");
  grid.className = "cards";

  items.slice(0,5).forEach((it, idx)=>{
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = getImage(it);
    img.alt = "project";
    card.appendChild(img);

    const cb = document.createElement("div");
    cb.className = "cb";

    const ct = document.createElement("div");
    ct.className = "ct";
    ct.textContent = `${idx+1}) ${it.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}`;
    cb.appendChild(ct);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.appendChild(tagEl(it.developer || "â€”"));

    const beds = it.unit_bedrooms || "";
    if(beds) meta.appendChild(tagEl("ØºØ±Ù: " + beds));

    const price = it.min_price || it.price || "";
    const curr  = it.price_currency || "";
    if(price) meta.appendChild(tagEl(`Ù…Ù† ${price} ${curr}`));

    cb.appendChild(meta);

    const c = getCoords(it);
    const a = document.createElement("a");
    a.className = "link";
    if(c){
      a.href = `https://maps.google.com/?q=${c.lat},${c.lng}`;
      a.target="_blank";
      a.rel="noopener";
      a.textContent = "ÙØªØ­ Ø¹Ù„Ù‰ Google Maps";
    }else{
      a.href="javascript:void(0)";
      a.style.opacity=".6";
      a.style.pointerEvents="none";
      a.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª";
    }
    cb.appendChild(a);

    card.appendChild(cb);
    grid.appendChild(card);
  });

  b.appendChild(grid);
  row.appendChild(b);
  chat.appendChild(row);
  scrollBottom();
}

function addQuickReplies(title, options){
  const row = document.createElement("div");
  row.className="row bot";
  const b = document.createElement("div");
  b.className="bubble";

  const t = document.createElement("div");
  t.textContent = title;
  b.appendChild(t);

  const wrap = document.createElement("div");
  wrap.className="quick";

  options.forEach(opt=>{
    const btn = document.createElement("button");
    btn.className="qbtn";
    btn.type="button";
    btn.textContent = opt.label;
    btn.addEventListener("click", ()=>{
      input.value = opt.value;
      input.focus();
    });
    wrap.appendChild(btn);
  });

  b.appendChild(wrap);
  row.appendChild(b);
  chat.appendChild(row);
  scrollBottom();
}

/* =========================
   ğŸ§  Prompt Understanding (Improved)
========================= */
function normalizeArabicDigitsToLatin(str){
  const map = { "Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9" };
  return str.replace(/[Ù -Ù©]/g, d => map[d] || d);
}

function parsePrompt(text){
  let t = normalizeArabicDigitsToLatin(text)
    .toLowerCase()
    .replace(/ØŒ|,/g," ")
    .replace(/[-â€“]/g," ")
    .replace(/\s+/g," ")
    .trim();

  const f = {
    country:"UAE",
    region:"",
    search_query:"",
    unit_bedrooms:"",
    unit_price_from:"",
    unit_price_to:"",
    post_handover:""
  };

  // Region
  if(/Ø£Ø¨Ùˆ ?Ø¸Ø¨ÙŠ|abu ?dhabi/.test(t)) f.region="Abu Dhabi";
  else if(/Ø§Ù„Ø´Ø§Ø±Ù‚Ø©|sharjah/.test(t)) f.region="Sharjah";
  else if(/Ø¯Ø¨ÙŠ|dubai/.test(t)) f.region="Dubai";

  // Popular areas / query
  if(/Ù…Ø§Ø±ÙŠÙ†Ø§|marina/.test(t)) f.search_query="Dubai Marina";
  else if(/Ø¯Ø§ÙˆÙ† ?ØªØ§ÙˆÙ†|downtown/.test(t)) f.search_query="Downtown Dubai";
  else if(/Ù†Ø®Ù„Ø©|palm/.test(t)) f.search_query="Palm Jumeirah";
  else if(/Ø¨Ø²Ù†Ø³ Ø¨Ø§ÙŠ|business bay/.test(t)) f.search_query="Business Bay";
  else if(/jvc|Ù‚Ø±ÙŠØ© Ø¬Ù…ÙŠØ±Ø§|jumeirah village circle/.test(t)) f.search_query="Jumeirah Village Circle";
  else f.search_query = f.region || "Dubai";

  // Bedrooms: studio
  if(/Ø§Ø³ØªÙˆØ¯ÙŠÙˆ|studio/.test(t)) f.unit_bedrooms="studio";

  // Bedrooms: digits + "ØºØ±Ù/bed"
  const b1 = t.match(/(\d+)\s*(?:ØºØ±Ù|ØºØ±ÙØ©|bed|beds|br)/);
  if(b1) f.unit_bedrooms = b1[1];

  // Bedrooms: "ØºØ±ÙØªÙŠÙ†" "Ø«Ù„Ø§Ø« ØºØ±Ù" (basic)
  if(!f.unit_bedrooms && /ØºØ±ÙØªÙŠÙ†|ØºØ±ÙØªØ§Ù†/.test(t)) f.unit_bedrooms="2";
  if(!f.unit_bedrooms && /Ø«Ù„Ø§Ø«\s*ØºØ±Ù|Ù£\s*ØºØ±Ù|3\s*ØºØ±Ù/.test(t)) f.unit_bedrooms="3";

  // Post handover
  if(/post handover|Ø¨ÙˆØ³Øª|Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…/.test(t)) f.post_handover="true";
  if(/Ø®Ù„Ø§Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡|Ø¹Ø§Ø¯ÙŠ|Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØ³Øª/.test(t)) f.post_handover="false";

  // Price:
  // "Ø¨ÙŠÙ† 1 Ùˆ 2 Ù…Ù„ÙŠÙˆÙ†" OR "1-2 Ù…Ù„ÙŠÙˆÙ†" OR "1 Ø¥Ù„Ù‰ 2"
  const between = t.match(/(?:Ø¨ÙŠÙ†)\s*(\d+(?:\.\d+)?)\s*(?:Ùˆ|Ø§Ù„Ù‰|Ø¥Ù„Ù‰)\s*(\d+(?:\.\d+)?)/);
  const dash = t.match(/(\d+(?:\.\d+)?)\s*(?:\s)\s*(\d+(?:\.\d+)?)/); // fallback weak
  const range = t.match(/(\d+(?:\.\d+)?)\s*(?:-|â€“|\s)\s*(\d+(?:\.\d+)?)(?:\s*m| Ù…Ù„ÙŠÙˆÙ†)?/);

  function toAED(n){
    // if small -> assume million
    const x = Number(n);
    if(!Number.isFinite(x)) return "";
    return String(x < 50 ? Math.round(x*1_000_000) : Math.round(x));
  }

  if(between){
    f.unit_price_from = toAED(between[1]);
    f.unit_price_to   = toAED(between[2]);
  } else if(range){
    f.unit_price_from = toAED(range[1]);
    f.unit_price_to   = toAED(range[2]);
  } else {
    const under = t.match(/(?:ØªØ­Øª|Ø§Ù‚Ù„ Ù…Ù†|Ø£Ù‚Ù„ Ù…Ù†|under)\s*(\d+(?:\.\d+)?)(?:\s*m| Ù…Ù„ÙŠÙˆÙ†)?/);
    const over  = t.match(/(?:ÙÙˆÙ‚|Ø§ÙƒØ«Ø± Ù…Ù†|Ø£ÙƒØ«Ø± Ù…Ù†|over)\s*(\d+(?:\.\d+)?)(?:\s*m| Ù…Ù„ÙŠÙˆÙ†)?/);
    if(under) f.unit_price_to = toAED(under[1]);
    if(over)  f.unit_price_from = toAED(over[1]);
  }

  // If user said "Ø´Ù‚Ø©" but no area, keep Dubai as query
  if(!f.search_query) f.search_query = f.region || "Dubai";

  return f;
}

/* =========================
   âœ… API (simple GET + header)
========================= */
function buildParams(obj){
  const p = new URLSearchParams();
  Object.entries(obj).forEach(([k,v])=>{
    if(v===undefined || v===null) return;
    const s = String(v).trim();
    if(s==="") return;
    p.append(k,s);
  });
  return p.toString();
}

async function fetchProjects(filters){
  const payload = {...filters, per_page: 5, page: 1};
  const url = `${API_BASE}?${buildParams(payload)}`;

  const r = await fetch(url, {
    method: "GET",
    headers: {
      [API_KEY_HEADER]: API_KEY,
      "accept": "application/json"
    }
  });

  const text = await r.text();
  let data = {};
  try{ data = JSON.parse(text); }catch{}

  if(!r.ok){
    return {ok:false, status:r.status, url, raw:data};
  }
  const items = data.items || data.data || data.results || [];
  return {ok:true, status:r.status, url, items};
}

/* =========================
   ğŸ§  Smart Fallback Strategy
   - ØªÙˆØ³Ù‘Ø¹ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø·Ù‚ÙŠ
========================= */
function clone(x){ return JSON.parse(JSON.stringify(x)); }

function widenPrice(filters, factorLow=0.8, factorHigh=1.25){
  const f = clone(filters);
  const from = Number(f.unit_price_from || "");
  const to   = Number(f.unit_price_to || "");
  if(Number.isFinite(from) && Number.isFinite(to) && from>0 && to>0){
    f.unit_price_from = String(Math.max(0, Math.round(from*factorLow)));
    f.unit_price_to   = String(Math.round(to*factorHigh));
  } else if(Number.isFinite(to) && to>0 && !from){
    f.unit_price_to = String(Math.round(to*factorHigh));
  } else if(Number.isFinite(from) && from>0 && !to){
    f.unit_price_from = String(Math.max(0, Math.round(from*factorLow)));
  }
  return f;
}

function broadenBedrooms(filters){
  // Ø¥Ø°Ø§ Ø·Ø§Ù„Ø¨ 2 ØºØ±ÙØŒ Ù†Ø¬Ø±Ø¨ 1..3 / Ø¥Ø°Ø§ 3 Ù†Ø¬Ø±Ø¨ 2..4
  const f = clone(filters);
  const b = f.unit_bedrooms;
  if(!b || b==="studio") return f;

  // Reelly ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ¯Ø¹Ù… Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ Ù„Ø°Ù„Ùƒ Ø¨Ù†Ø¹Ù…Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ù‚ÙŠÙ…Ø©
  return f;
}

function removeTightFilters(filters, opts){
  const f = clone(filters);
  if(opts.dropPostHandover) f.post_handover = "";
  if(opts.dropBedrooms) f.unit_bedrooms = "";
  if(opts.dropPrice) { f.unit_price_from=""; f.unit_price_to=""; }
  if(opts.broadenArea) f.search_query = f.region || "Dubai";
  if(opts.superBroad) { f.region=""; f.search_query="Dubai"; }
  return f;
}

async function searchWithFallback(original){
  const attempts = [];

  // A0: exact
  attempts.push({label:"A0: Exact", filters: clone(original)});

  // A1: drop post handover
  attempts.push({label:"A1: Drop post_handover", filters: removeTightFilters(original,{dropPostHandover:true})});

  // A2: widen price
  attempts.push({label:"A2: Widen price", filters: widenPrice(removeTightFilters(original,{dropPostHandover:true}), 0.8, 1.25)});

  // A3: broaden area query (Dubai instead of specific area)
  attempts.push({label:"A3: Broaden area", filters: removeTightFilters(original,{dropPostHandover:true,broadenArea:true})});

  // A4: drop bedrooms
  attempts.push({label:"A4: Drop bedrooms", filters: removeTightFilters(original,{dropPostHandover:true,broadenArea:true,dropBedrooms:true})});

  // A5: drop price
  attempts.push({label:"A5: Drop price", filters: removeTightFilters(original,{dropPostHandover:true,broadenArea:true,dropBedrooms:true,dropPrice:true})});

  // A6: super broad
  attempts.push({label:"A6: Super broad", filters: removeTightFilters(original,{superBroad:true,dropPrice:true,dropBedrooms:true,dropPostHandover:true})});

  for(let i=0;i<attempts.length;i++){
    const att = attempts[i];
    bot(`ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© ${i+1}/${attempts.length}â€¦ (${att.label})`);

    dbg("FILTERS:\n"+JSON.stringify(att.filters,null,2));

    const res = await fetchProjects(att.filters);

    if(!res.ok){
      dbg(`HTTP ${res.status}\n${res.url}`);
      // Ø¥Ø°Ø§ Ù…ØµØ§Ø¯Ù‚Ø© Ø£Ùˆ Ù…Ù†Ø¹ØŒ Ø®Ø±ÙˆØ¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
      if(res.status === 401 || res.status === 403) return {ok:false, fatal:true, reason:"AUTH", last:res};
      continue;
    }

    dbg(`OK 200\ncount: ${res.items.length}\n${res.url}`);

    if(res.items.length){
      return {ok:true, items: res.items, usedLabel: att.label, usedFilters: att.filters};
    }
  }

  return {ok:false, fatal:false, reason:"NO_RESULTS"};
}

/* =========================
   ğŸ¤ Clarifying Questions + Smart Suggestions
========================= */
function askClarifying(original){
  warn("Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£Ù„Ø§Ù‚ÙŠ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ…Ø§Ù…Ù‹Ø§. Ø®Ù„Ù‘ÙŠÙ†Ø§ Ù†Ø­Ø¯Ø¯ Ø´ÙˆÙŠ ğŸ‘‡");

  const missing = [];
  if(!original.region) missing.push("Ø§Ù„Ø¥Ù…Ø§Ø±Ø©");
  if(!original.unit_bedrooms) missing.push("Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù");
  if(!original.unit_price_from && !original.unit_price_to) missing.push("Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±");
  if(!original.search_query) missing.push("Ø§Ù„Ù…Ù†Ø·Ù‚Ø©");

  if(missing.length){
    bot("Ù†Ø§Ù‚ØµÙ†ÙŠ: " + missing.join(" + ") + " (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ø¨Ø³ Ø¨ÙŠØ³Ø§Ø¹Ø¯Ù†ÙŠ Ø£Ø¹Ø·ÙŠÙƒ Ù†ØªØ§Ø¦Ø¬ Ø£Ø¯Ù‚).");
  }

  addQuickReplies("Ø§Ø®ØªØ§Ø± ÙˆØ§Ø­Ø¯ Ø¨Ø³Ø±Ø¹Ø©:", [
    {label:"ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø³Ø¹Ø± (0.8â€“2.5M)", value:"Ø¯Ø¨ÙŠ Ø¨ÙŠÙ† 0.8 Ùˆ 2.5 Ù…Ù„ÙŠÙˆÙ†"},
    {label:"Ø´ÙˆÙ ÙƒÙ„ Ø¯Ø¨ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ù†Ø·Ù‚Ø©)", value:"Ø¯Ø¨ÙŠ"},
    {label:"ØºØ±ÙØ© Ø£Ùˆ ØºØ±ÙØªÙŠÙ†", value:"Ø¯Ø¨ÙŠ 1 Ø£Ùˆ 2 ØºØ±Ù"},
    {label:"Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØ³Øª Ù‡Ø§Ù†Ø¯ Ø£ÙˆÙØ±", value:"Ø¯Ø¨ÙŠ Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØ³Øª Ù‡Ø§Ù†Ø¯ Ø£ÙˆÙØ±"},
  ]);

  addQuickReplies("Ø£Ùˆ Ø¬Ø§ÙˆØ¨Ù†ÙŠ Ø¨Ø³Ø¤Ø§Ù„ ÙˆØ§Ø­Ø¯:", [
    {label:"Ø¨Ø¯Ùƒ Ø£ÙŠ Ù…Ù†Ø·Ù‚Ø© ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ØŸ (Marina / Downtown / JVC)", value:"Ø¨Ø¯Ù‘ÙŠ Marina"},
    {label:"Ù‚Ø¯ÙŠØ´ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø¨Ø§Ù„Ø¶Ø¨Ø·ØŸ (Ù…Ø«Ø§Ù„ 1-2M)", value:"Ù…ÙŠØ²Ø§Ù†ÙŠØªÙŠ Ø¨ÙŠÙ† 1 Ùˆ 2 Ù…Ù„ÙŠÙˆÙ†"},
    {label:"ÙƒÙ… ØºØ±ÙØ© Ø¨Ø¯ÙƒØŸ (studio/1/2/3)", value:"Ø¨Ø¯Ù‘ÙŠ 2 ØºØ±Ù"},
  ]);
}

function smartSuggestions(original){
  bot("Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„ØªØ²ÙŠØ¯ ÙØ±Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:");
  const opts = [];

  if(original.search_query && original.search_query !== (original.region||"Dubai")){
    opts.push({label:`Ø¨Ø¯ÙˆÙ† ${original.search_query}`, value:`${original.region||"Ø¯Ø¨ÙŠ"} Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ù…Ù†Ø·Ù‚Ø©`});
  }
  if(original.unit_bedrooms){
    opts.push({label:"Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ø§Ù„ØºØ±Ù", value:`${original.region||"Ø¯Ø¨ÙŠ"} Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù`});
  }
  if(original.unit_price_from || original.unit_price_to){
    opts.push({label:"Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ø§Ù„Ø³Ø¹Ø±", value:`${original.region||"Ø¯Ø¨ÙŠ"} Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ø³Ø¹Ø±`});
    opts.push({label:"ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø³Ø¹Ø± 20%", value:`${original.region||"Ø¯Ø¨ÙŠ"} Ø¨ÙŠÙ† 0.8 Ùˆ 2.5 Ù…Ù„ÙŠÙˆÙ†`});
  }
  if(original.post_handover){
    opts.push({label:"Ø¨Ø¯ÙˆÙ† Post Handover", value:`${original.region||"Ø¯Ø¨ÙŠ"} Ø¨Ø¯ÙˆÙ† Ø¨ÙˆØ³Øª Ù‡Ø§Ù†Ø¯ Ø£ÙˆÙØ±`});
  }

  if(!opts.length){
    opts.push({label:"Ø¬Ø±Ù‘Ø¨ Dubai ÙÙ‚Ø·", value:"Dubai"});
  }

  addQuickReplies("Ø¬Ø±Ù‘Ø¨ ÙˆØ§Ø­Ø¯ Ù…Ù†Ù‡Ù…:", opts.slice(0,6));
}

/* =========================
   Chat Flow
========================= */
function greet(){
  bot("Ø£Ù‡Ù„Ù‹Ø§ ğŸ‘‹\nØ§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ Ø¨Ø­Ø±ÙŠØ© (Ù…Ù†Ø·Ù‚Ø© + ØºØ±Ù + Ø³Ø¹Ø±)ØŒ ÙˆØ£Ù†Ø§ Ø£Ø¬ÙŠØ¨ Ø£ÙØ¶Ù„ 5 Ù†ØªØ§Ø¦Ø¬.");
  warn("Ù„Ùˆ Ù…Ø§ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©ØŒ Ø±Ø­ Ø£ÙˆØ³Ù‘Ø¹ Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø·ÙŠÙƒ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª/Ø³Ø¤Ø§Ù„ ØªÙˆØ¶ÙŠØ­ÙŠ Ø¨Ø¯Ù„ Ø§Ù„Ø±ÙØ¶.");
}
function reset(){
  chat.innerHTML="";
  greet();
}
reset();

async function handleSend(){
  const q = input.value.trim();
  if(!q) return;
  input.value="";
  user(q);

  if(q === "Ø¥Ø¹Ø§Ø¯Ø©" || q.toLowerCase() === "reset"){
    reset();
    return;
  }

  const parsed = parsePrompt(q);

  bot(
`ØªÙ…Ø§Ù… âœ… ÙÙ‡Ù…Øª Ø·Ù„Ø¨Ùƒ:
ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${parsed.search_query || "Any"} (${parsed.region || "Any"})
ğŸ›ï¸ Ø§Ù„ØºØ±Ù: ${parsed.unit_bedrooms || "Any"}
ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${parsed.unit_price_from || "â€”"} â†’ ${parsed.unit_price_to || "â€”"}
ğŸ§¾ Post Handover: ${parsed.post_handover || "Any"}

Ø¹Ù… Ø£Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†...`
  );

  const out = await searchWithFallback(parsed);

  if(out.ok){
    if(out.usedLabel !== "A0: Exact"){
      warn(`Ù…Ø§ Ù„Ù‚ÙŠØª Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© 100%ØŒ ÙÙˆØ³Ù‘Ø¹Øª Ø§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (${out.usedLabel}) ÙˆÙ‡Ø§ÙŠ Ø£Ù‚Ø±Ø¨ Ù†ØªØ§Ø¦Ø¬ ğŸ‘‡`);
    }
    renderCardsInBot(out.items);
    return;
  }

  if(out.fatal && out.reason === "AUTH"){
    bot(`âŒ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù€ API\nStatus: ${out.last.status}\n\nØºØ§Ù„Ø¨Ù‹Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù…Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.`);
    return;
  }

  // No results after all fallbacks:
  askClarifying(parsed);
  smartSuggestions(parsed);
}

document.getElementById("sendBtn").addEventListener("click", handleSend);
input.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); handleSend(); }});
document.getElementById("resetBtn").addEventListener("click", reset);
document.getElementById("exampleBtn").addEventListener("click", ()=>{
  input.value = "Ø´Ù‚Ø© ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„ÙˆÙ† Ø¨Ø¯Ø¨ÙŠ Ù…Ø§Ø±ÙŠÙ†Ø§ Ø¨ÙŠÙ† 1 Ùˆ 2 Ù…Ù„ÙŠÙˆÙ† Ø¨ÙˆØ³Øª Ù‡Ø§Ù†Ø¯ Ø£ÙˆÙØ±";
  input.focus();
});
</script>
</body>
</html>

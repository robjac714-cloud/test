<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Real Estate Chat Bot</title>
  <style>
    body{font-family:system-ui;background:#f6f7fb;margin:0;padding:18px}
    .wrap{max-width:900px;margin:auto;display:grid;grid-template-columns:1.2fr 1fr;gap:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 10px 25px rgba(15,23,42,.06)}
    .head{padding:12px 14px;border-bottom:1px solid #eef2ff;font-weight:800}
    .chat{height:520px;overflow:auto;padding:12px 14px}
    .msg{margin:10px 0;display:flex}
    .b{max-width:85%;padding:10px 12px;border-radius:14px;line-height:1.7;white-space:pre-wrap}
    .me{justify-content:flex-start}
    .me .b{background:#eef2ff}
    .bot{justify-content:flex-end}
    .bot .b{background:#f1f5f9}
    .bar{display:flex;gap:10px;padding:12px 14px;border-top:1px solid #eef2ff}
    input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;font-size:15px}
    button{padding:10px 14px;border:0;border-radius:12px;background:#111827;color:#fff;font-weight:800;cursor:pointer}
    textarea{width:100%;height:520px;border:0;outline:0;padding:12px 14px;border-radius:16px;resize:none;white-space:pre-wrap}
    @media (max-width: 900px){.wrap{grid-template-columns:1fr}.chat,textarea{height:420px}}
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="head">الشات</div>
    <div id="chat" class="chat"></div>
    <div class="bar">
      <input id="inp" placeholder="مثال: بدي شقة غرفتين بدبي مارينا ميزانيتي 1.6 مليون" />
      <button id="send">إرسال</button>
    </div>
  </div>

  <div class="card">
    <div class="head">ملخص طلب المستخدم</div>
    <textarea id="summary" readonly></textarea>
  </div>
</div>

<script>
/* =========================
   1) ضع المفتاح هنا
   ========================= */
const OPENAI_API_KEY = "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"; // ← المفتاح الجديد فقط

/* ========================= */
const chatEl = document.getElementById("chat");
const inp = document.getElementById("inp");
const sendBtn = document.getElementById("send");
const summaryEl = document.getElementById("summary");
const history = [];

function addMsg(text, who){
  const row = document.createElement("div");
  row.className = "msg " + who;
  const b = document.createElement("div");
  b.className = "b";
  b.textContent = text;
  row.appendChild(b);
  chatEl.appendChild(row);
  chatEl.scrollTop = chatEl.scrollHeight;
}

function buildSummary(e){
  const s=v=>v&&v!=="unknown"?v:"unknown";
  return `
Intent: ${s(e.intent)}
City: ${s(e.city)} | Area: ${s(e.area)}
Type: ${s(e.property_type)} | Bedrooms: ${s(e.bedrooms)}
Budget: ${s(e.budget)}
Ready/Offplan: ${s(e.ready_or_offplan)}
Notes: ${s(e.notes)}
`.trim();
}

async function send(){
  const msg = inp.value.trim();
  if(!msg) return;

  addMsg(msg,"me");
  inp.value="";

  const payload = {
    model: "gpt-4o-mini",
    messages: [
      {role:"system",content:"أنت شات بوت عقاري ذكي. استخرج طلب المستخدم العقاري ورد عليه بشكل بسيط، وأرجع JSON فيه assistant_message و extracted."},
      {role:"user",content:msg}
    ],
    response_format:{
      type:"json_schema",
      json_schema:{
        name:"real_estate_bot",
        schema:{
          type:"object",
          properties:{
            assistant_message:{type:"string"},
            extracted:{
              type:"object",
              properties:{
                intent:{type:"string"},
                city:{type:"string"},
                area:{type:"string"},
                property_type:{type:"string"},
                bedrooms:{type:"string"},
                budget:{type:"string"},
                ready_or_offplan:{type:"string"},
                notes:{type:"string"}
              }
            }
          },
          required:["assistant_message","extracted"]
        }
      }
    }
  };

  const r = await fetch("https://api.openai.com/v1/chat/completions",{
    method:"POST",
    headers:{
      "Authorization":"Bearer "+OPENAI_API_KEY,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(payload)
  });

  const d = await r.json();
  const out = JSON.parse(d.choices[0].message.content);

  addMsg(out.assistant_message,"bot");
  summaryEl.value = buildSummary(out.extracted);
}

sendBtn.onclick=send;
addMsg("أهلاً! احكيلي شو العقار اللي بدك ياه.","bot");
</script>
</body>
</html>

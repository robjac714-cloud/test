<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Property Chat Bot</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;
      --panel:#ffffff;
      --stroke:#e5e7eb;
      --muted:#6b7280;
      --text:#111827;
      --accent:#2563eb;
      --accent2:#0ea5e9;
      --bot:#eef2ff;
      --user:#ecfeff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:"Cairo",system-ui,-apple-system,Segoe UI,Tahoma;
      display:flex; justify-content:center; padding:16px;
    }
    .app{
      width:min(920px, 100%);
      height:min(92vh, 820px);
      display:flex; flex-direction:column;
      border:1px solid var(--stroke);
      border-radius:18px;
      background:var(--panel);
      box-shadow:0 16px 40px rgba(15,23,42,.08);
      overflow:hidden;
    }
    .topbar{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(90deg,#fff,#f9fafb);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .pill{
      width:34px; height:34px; border-radius:999px;
      background:radial-gradient(circle at 30% 30%, var(--accent2), var(--accent));
      display:grid; place-items:center; color:#fff;
      font-weight:900;
    }
    .sub{
      font-size:12px; color:var(--muted); font-weight:600;
    }
    .actions{
      display:flex; align-items:center; gap:8px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:#1f2937;
    }
    .btn.primary{
      border:0;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff;
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }

    .chat{
      flex:1;
      padding:14px;
      overflow:auto;
      background:
        radial-gradient(circle at top, rgba(209,213,219,0.55) 0, rgba(245,245,247,1) 60%);
    }

    .row{ display:flex; margin:10px 0; }
    .row.bot{ justify-content:flex-start; }
    .row.user{ justify-content:flex-end; }

    .bubble{
      max-width:min(78%, 620px);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      line-height:1.5;
      font-size:14px;
      white-space:pre-wrap;
    }
    .row.bot .bubble{ background:var(--bot); border-top-right-radius:6px; }
    .row.user .bubble{ background:var(--user); border-top-left-radius:6px; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .chip{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:999px;
      padding:7px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:#111827;
      user-select:none;
    }
    .chip:hover{ border-color:#bfdbfe; }

    .composer{
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex; gap:10px;
      background:#fff;
    }
    input{
      flex:1;
      border:1px solid #d1d5db;
      border-radius:12px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    input:focus{ border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.12); }
    .send{
      border:0;
      border-radius:12px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:900;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:#fff;
    }

    .card{
      background:#fff;
      border:1px solid var(--stroke);
      border-radius:14px;
      overflow:hidden;
      margin-top:10px;
    }
    .card img{
      width:100%;
      aspect-ratio:16/9;
      object-fit:cover;
      background:#e5e7eb;
      display:block;
    }
    .card .cb{
      padding:10px 12px 12px;
    }
    .title{ font-weight:900; margin-bottom:6px; }
    .meta{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      font-size:12px;
      background:#f3f4f6;
      border:1px solid var(--stroke);
      padding:3px 8px;
      border-radius:999px;
      color:#374151;
      font-weight:800;
    }
    .link{
      display:block;
      margin-top:10px;
      text-align:center;
      border:1px solid #d1d5db;
      background:#f9fafb;
      border-radius:999px;
      padding:8px 10px;
      text-decoration:none;
      color:#2563eb;
      font-weight:900;
      font-size:13px;
    }
    .mutedline{ font-size:12px; color:var(--muted); margin-top:6px; }
    .hr{ height:1px; background:var(--stroke); margin:10px 0; }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="pill">CM</div>
        <div>
          <div>Property Chat Bot</div>
          <div class="sub">ÙÙ„ØªØ±Ø© + Ø£ÙØ¶Ù„ 5 Ù†ØªØ§Ø¦Ø¬</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡</button>
        <button class="btn primary" id="demo">ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©</button>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="composer">
      <input id="input" placeholder="Ø§ÙƒØªØ¨ Ø¬ÙˆØ§Ø¨Ùƒ Ù‡Ù†Ø§â€¦ (Ù…Ø«Ø§Ù„: Dubai)" autocomplete="off" />
      <button class="send" id="send">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

<script>
/** =========================
 *  API CONFIG (Ù…Ø«Ù„ ÙƒÙˆØ¯Ùƒ)
 *  ========================= */
const API_BASE  = "https://search-listings-production.up.railway.app/v1/properties";
const API_KEY   = "reelly-80fd5f24-WLrF9bAxkGwYrUXFjrIyzNxRlzrB4kpH";
const API_KEY_HEADER = "X-API-Key";

/** =========================
 *  UI Helpers
 *  ========================= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const resetBtn = document.getElementById("reset");
const demoBtn = document.getElementById("demo");

function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }

function addBubble(text, who="bot"){
  const row = document.createElement("div");
  row.className = "row " + who;
  const b = document.createElement("div");
  b.className = "bubble";
  b.textContent = text;
  row.appendChild(b);
  chat.appendChild(row);
  scrollBottom();
  return b;
}

function addChips(options, onPick){
  const row = document.createElement("div");
  row.className = "row bot";
  const wrap = document.createElement("div");
  wrap.className = "bubble";
  const chips = document.createElement("div");
  chips.className = "chips";
  options.forEach(opt=>{
    const c = document.createElement("div");
    c.className = "chip";
    c.textContent = opt.label ?? opt;
    c.addEventListener("click", ()=>onPick(opt.value ?? opt));
    chips.appendChild(c);
  });
  wrap.appendChild(chips);
  row.appendChild(wrap);
  chat.appendChild(row);
  scrollBottom();
}

function addCards(items){
  const row = document.createElement("div");
  row.className = "row bot";
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = "Ø£ÙØ¶Ù„ 5 Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ ğŸ‘‡";
  row.appendChild(bubble);
  chat.appendChild(row);

  items.forEach((it, idx)=>{
    const cardRow = document.createElement("div");
    cardRow.className = "row bot";
    const bubble2 = document.createElement("div");
    bubble2.className = "bubble";

    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.src = getImage(it);
    img.alt = "project";
    card.appendChild(img);

    const cb = document.createElement("div");
    cb.className = "cb";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = `${idx+1}) ${it.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}`;
    cb.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.appendChild(tag(it.developer || "â€”"));
    if(it.unit_bedrooms) meta.appendChild(tag("ØºØ±Ù: " + it.unit_bedrooms));
    const area = it.area || it.unit_area;
    if(area) meta.appendChild(tag("Ù…Ø³Ø§Ø­Ø©: " + area));
    const price = it.min_price || it.price;
    const curr  = it.price_currency || "";
    if(price) meta.appendChild(tag(`Ù…Ù† ${price} ${curr}`));
    card.appendChild(cb);

    cb.appendChild(meta);

    const c = getCoords(it);
    const a = document.createElement("a");
    a.className = "link";
    if(c){
      a.href = `https://maps.google.com/?q=${c.lat},${c.lng}`;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = "ÙØªØ­ Ø¹Ù„Ù‰ Google Maps";
    } else {
      a.href = "javascript:void(0)";
      a.style.opacity = ".6";
      a.style.pointerEvents = "none";
      a.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª";
    }
    cb.appendChild(a);

    const muted = document.createElement("div");
    muted.className = "mutedline";
    muted.textContent = "Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ØªØ¹Ø¯Ù‘Ù„ Ø§Ù„ÙÙ„Ø§ØªØ±: Ø§ÙƒØªØ¨ (Ø¥Ø¹Ø§Ø¯Ø©) Ø£Ùˆ Ø§Ø¶ØºØ· Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡.";
    cb.appendChild(muted);

    bubble2.appendChild(card);
    cardRow.appendChild(bubble2);
    chat.appendChild(cardRow);
  });

  scrollBottom();
}
function tag(t){
  const s = document.createElement("span");
  s.className = "tag";
  s.textContent = t;
  return s;
}

/** =========================
 *  Data Helpers (Ù…Ù† ÙƒÙˆØ¯Ùƒ)
 *  ========================= */
function tryParseJSON(s){ try{ return JSON.parse(s) }catch{return null;} }
function isImg(u){ return typeof u==="string" && /^https?:\/\//.test(u); }
function getImage(it){
  if(typeof it.cover_image_url==="string"){
    const p=tryParseJSON(it.cover_image_url);
    if(p?.url) return p.url;
    if(isImg(it.cover_image_url)) return it.cover_image_url;
  }
  return "https://dummyimage.com/900x506/e5e7eb/111827&text=No+Image";
}
function getCoords(it){
  if(typeof it.coordinates==="string"){
    const parts = it.coordinates.split(",").map(v=>Number(v.trim()));
    if(parts.length>=2 && parts.every(Number.isFinite)) return {lat:parts[0], lng:parts[1]};
  }
  return null;
}
function buildParams(obj){
  const p=new URLSearchParams();
  Object.entries(obj).forEach(([k,v])=>{
    if(v===undefined || v===null) return;
    const s=String(v).trim();
    if(s==="") return;
    p.append(k,s);
  });
  return p.toString();
}

/** =========================
 *  API Fetch (GET Ø«Ù… POST)
 *  ========================= */
async function smartFetch(payload){
  const qs = buildParams(payload);

  // GET
  let url = `${API_BASE}?${qs}`;
  let r = await fetch(url,{
    method:"GET",
    headers:{ [API_KEY_HEADER]:API_KEY, "accept":"application/json" }
  });
  if(r.ok) return {r,url};

  // POST
  url = API_BASE;
  r = await fetch(url,{
    method:"POST",
    headers:{ [API_KEY_HEADER]:API_KEY, "Content-Type":"application/json", "accept":"application/json" },
    body: JSON.stringify(payload)
  });
  return {r,url};
}

/** =========================
 *  Bot State Machine
 *  ========================= */
const state = {
  step: 0,
  filters: {
    country: "UAE",
    region: "",
    search_query: "",
    unit_price_from: "",
    unit_price_to: "",
    unit_bedrooms: "",
    developer: "",
    post_handover: ""
  }
};

function resetBot(){
  state.step = 0;
  state.filters = { country:"UAE", region:"", search_query:"", unit_price_from:"", unit_price_to:"", unit_bedrooms:"", developer:"", post_handover:"" };
  chat.innerHTML = "";
  greet();
}

function greet(){
  addBubble("Ø£Ù‡Ù„Ù‹Ø§ ğŸ‘‹\nØ£Ù†Ø§ Ø¨ÙˆØª Ø¹Ù‚Ø§Ø±Ø§Øª.\nØ¨Ø³ Ø¬Ø§ÙˆØ¨Ù†ÙŠ ÙƒÙ… Ø³Ø¤Ø§Ù„ ÙˆØ¨Ø·Ù„Ø¹Ù„Ùƒ Ø£ÙØ¶Ù„ 5 Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ù†Ø§Ø³Ø¨Ø©.");
  askStep();
}

function askStep(){
  if(state.step === 0){
    addBubble("1) Ø¨Ø£ÙŠ Ø¥Ù…Ø§Ø±Ø© Ø¨Ø¯Ùƒ ØªØ¨Ø­Ø«ØŸ");
    addChips([
      {label:"Dubai", value:"Dubai"},
      {label:"Abu Dhabi", value:"Abu Dhabi"},
      {label:"Sharjah", value:"Sharjah"},
      {label:"UAE (ÙƒÙ„ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª)", value:"UAE"}
    ], v => handleUser(v));
    return;
  }
  if(state.step === 1){
    addBubble("2) Ø§ÙƒØªØ¨ Ù…Ù†Ø·Ù‚Ø©/ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ© (Ù…Ø«Ø§Ù„: Marina / Downtown / JVC) Ø£Ùˆ Ø§ÙƒØªØ¨: ØªØ®Ø·ÙŠ");
    addChips(["Marina","Downtown","JVC","Business Bay","Palm Jumeirah","ØªØ®Ø·ÙŠ"], v => handleUser(v));
    return;
  }
  if(state.step === 2){
    addBubble("3) Ø§Ø®ØªØ± Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (AED) Ø£Ùˆ Ø§ÙƒØªØ¨: ØªØ®Ø·ÙŠ");
    addChips([
      {label:"Ø£Ù‚Ù„ Ù…Ù† 1M", value:"<1m"},
      {label:"1M - 2M", value:"1-2m"},
      {label:"Ø£ÙƒØ«Ø± Ù…Ù† 2M", value:">2m"},
      {label:"ØªØ®Ø·ÙŠ", value:"skip"}
    ], v => handleUser(v));
    return;
  }
  if(state.step === 3){
    addBubble("4) Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±ÙØŸ (Studio / 1 / 2 / 3+) Ø£Ùˆ Ø§ÙƒØªØ¨: ØªØ®Ø·ÙŠ");
    addChips([
      {label:"Studio", value:"studio"},
      {label:"1", value:"1"},
      {label:"2", value:"2"},
      {label:"3+", value:"3"},
      {label:"ØªØ®Ø·ÙŠ", value:"skip"}
    ], v => handleUser(v));
    return;
  }
  if(state.step === 4){
    addBubble("5) Ø¨Ø¯Ùƒ Ø®Ø·Ø© Ø¯ÙØ¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ… (Post Handover)ØŸ");
    addChips([
      {label:"Ù†Ø¹Ù…", value:"true"},
      {label:"Ù„Ø§", value:"false"},
      {label:"ØªØ®Ø·ÙŠ", value:"skip"}
    ], v => handleUser(v));
    return;
  }
  if(state.step === 5){
    runSearch();
  }
}

function normalize(text){
  return String(text || "").trim();
}

function handleUser(text){
  const msg = normalize(text);
  if(!msg) return;

  addBubble(msg, "user");

  // Ø£ÙˆØ§Ù…Ø± Ø¹Ø§Ù…Ø©
  const lower = msg.toLowerCase();
  if(msg === "Ø¥Ø¹Ø§Ø¯Ø©" || msg === "reset" || lower.includes("restart")){
    resetBot();
    return;
  }

  // Ø®Ø·ÙˆØ§Øª
  if(state.step === 0){
    // region
    if(msg === "UAE"){
      state.filters.region = "";
      state.filters.search_query = "UAE";
    } else {
      state.filters.region = msg;
      state.filters.search_query = msg; // ÙƒØ¨Ø¯Ø§ÙŠØ©
    }
    state.step = 1;
    askStep();
    return;
  }

  if(state.step === 1){
    if(msg !== "ØªØ®Ø·ÙŠ" && msg.toLowerCase() !== "skip"){
      state.filters.search_query = msg;
    }
    state.step = 2;
    askStep();
    return;
  }

  if(state.step === 2){
    // price preset
    if(msg === "<1m"){
      state.filters.unit_price_from = "";
      state.filters.unit_price_to = "1000000";
    } else if(msg === "1-2m"){
      state.filters.unit_price_from = "1000000";
      state.filters.unit_price_to = "2000000";
    } else if(msg === ">2m"){
      state.filters.unit_price_from = "2000000";
      state.filters.unit_price_to = "";
    } else if(msg !== "skip" && msg !== "ØªØ®Ø·ÙŠ"){
      // Ù„Ùˆ ÙƒØªØ¨ Ø±Ù‚Ù…ÙŠÙ† Ø¨ØµÙŠØºØ© "500000-1500000"
      const m = msg.replace(/\s/g,"").split("-");
      if(m.length === 2){
        state.filters.unit_price_from = m[0];
        state.filters.unit_price_to = m[1];
      }
    }
    state.step = 3;
    askStep();
    return;
  }

  if(state.step === 3){
    if(msg !== "skip" && msg !== "ØªØ®Ø·ÙŠ"){
      state.filters.unit_bedrooms = msg;
    }
    state.step = 4;
    askStep();
    return;
  }

  if(state.step === 4){
    if(msg !== "skip" && msg !== "ØªØ®Ø·ÙŠ"){
      state.filters.post_handover = msg; // true/false
    }
    state.step = 5;
    askStep();
    return;
  }
}

async function runSearch(){
  addBubble("ØªÙ…Ø§Ù… âœ… Ø¹Ù… Ø¯ÙˆØ± Ù„Ùƒ Ù‡Ù„Ù‘Ù‚ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ 5 Ù†ØªØ§Ø¦Ø¬...");

  const payload = {
    country: state.filters.country,
    region: state.filters.region,
    search_query: state.filters.search_query,
    unit_price_from: state.filters.unit_price_from,
    unit_price_to: state.filters.unit_price_to,
    unit_bedrooms: state.filters.unit_bedrooms,
    developer: state.filters.developer,
    post_handover: state.filters.post_handover,
    per_page: 5,
    page: 1
  };

  try{
    const {r, url} = await smartFetch(payload);
    const text = await r.text();
    let data={}; try{ data=JSON.parse(text); }catch(e){}

    if(!r.ok){
      addBubble(`ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø¬Ù„Ø¨ âŒ\nStatus: ${r.status}\nØ¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙÙ„Ø§ØªØ±.\n\n(ØªÙØ§ØµÙŠÙ„) ${url}`);
      return;
    }

    const items = data.items || data.data || data.results || [];
    if(!items.length){
      addBubble("Ù…Ø§ Ù„Ù‚ÙŠØª Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© ğŸ˜•\nØ¬Ø±Ù‘Ø¨ ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±.\nØ§ÙƒØªØ¨: Ø¥Ø¹Ø§Ø¯Ø©");
      return;
    }

    addCards(items);
    addBubble("Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ØªØ¹Ù…Ù„ Ø¨Ø­Ø« Ø¬Ø¯ÙŠØ¯: Ø§ÙƒØªØ¨ (Ø¥Ø¹Ø§Ø¯Ø©) Ø£Ùˆ Ø§Ø¶ØºØ· Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡.");

  } catch(err){
    addBubble("ØµØ§Ø± Ø®Ø·Ø£ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ© âŒ\nØªØ£ÙƒØ¯ Ø¥Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ø´ØºÙ‘Ø§Ù„ ÙˆØ¥Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø§ Ø¹Ù… ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
  }
}

/** =========================
 *  Events
 *  ========================= */
sendBtn.addEventListener("click", ()=>{ handleUser(input.value); input.value=""; input.focus(); });
input.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); sendBtn.click(); }
});
resetBtn.addEventListener("click", resetBot);
demoBtn.addEventListener("click", ()=>{
  // ÙŠØ¹Ø¨Ù‘ÙŠ Ù‚ÙŠÙ… ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø³Ø±ÙŠØ¹Ù‹Ø§
  addBubble("Ù…Ø´Ø±ÙˆØ¹", "user");
  state.step = 0;
  handleUser("Dubai");
  handleUser("Marina");
  handleUser("1-2m");
  handleUser("2");
  handleUser("true");
});

resetBot();
</script>
</body>
</html>

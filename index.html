<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reelly Chat Bot</title>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Tahoma;
      background:#f5f5f7;
      display:flex;
      justify-content:center;
      padding:20px;
    }
    .chatbox{
      width:100%;
      max-width:900px;
      height:85vh;
      background:#fff;
      border-radius:16px;
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.08);
    }
    .header{
      padding:14px;
      border-bottom:1px solid #e5e7eb;
      font-weight:900;
    }
    .chat{
      flex:1;
      padding:14px;
      overflow:auto;
      background:#f9fafb;
    }
    .row{display:flex;margin-bottom:12px}
    .bot{justify-content:flex-start}
    .user{justify-content:flex-end}
    .bubble{
      max-width:75%;
      padding:10px 14px;
      border-radius:14px;
      font-size:14px;
      line-height:1.6;
    }
    .bot .bubble{background:#eef2ff}
    .user .bubble{background:#ecfeff}

    .composer{
      border-top:1px solid #e5e7eb;
      padding:12px;
      display:flex;
      gap:10px;
    }
    input{
      flex:1;
      padding:12px;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:14px;
    }
    button{
      padding:12px 16px;
      border-radius:12px;
      border:0;
      background:#2563eb;
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }

    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
      margin-top:10px;
    }
    .card{
      background:#fff;
      border-radius:14px;
      border:1px solid #e5e7eb;
      overflow:hidden;
    }
    .card img{
      width:100%;
      aspect-ratio:16/10;
      object-fit:cover;
      background:#e5e7eb;
    }
    .card-body{padding:10px}
    .title{font-weight:800}
    .meta{font-size:12px;color:#555}
  </style>
</head>

<body>

<div class="chatbox">
  <div class="header">ğŸ¤– Reelly Chat Bot</div>

  <div class="chat" id="chat"></div>

  <div class="composer">
    <input id="input" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ... (Ù…Ø«Ø§Ù„: 2 ØºØ±Ù Ø¨Ø¯Ø¨ÙŠ Ø¨ÙŠÙ† 1 Ùˆ 2 Ù…Ù„ÙŠÙˆÙ†)">
    <button id="send">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<script>
const API_BASE = "https://search-listings-production.up.railway.app/v1/properties";
const API_KEY  = "reelly-80fd5f24-WLrF9bAxkGwYrUXFjrIyzNxRlzrB4kpH";

const chat = document.getElementById("chat");
const input = document.getElementById("input");

function bubble(text, who){
  const r=document.createElement("div");
  r.className="row "+who;
  const b=document.createElement("div");
  b.className="bubble";
  b.textContent=text;
  r.appendChild(b);
  chat.appendChild(r);
  chat.scrollTop=chat.scrollHeight;
}

function getImage(it){
  if(it.cover_image_url){
    try{
      const p=JSON.parse(it.cover_image_url);
      if(p.url) return p.url;
    }catch{}
    if(it.cover_image_url.startsWith("http")) return it.cover_image_url;
  }
  return "https://dummyimage.com/800x500/e5e7eb/111827&text=No+Image";
}

/* ğŸ§  ÙÙ‡Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ· */
function parsePrompt(text){
  const t=text.toLowerCase();
  const f={country:"UAE", region:"", search_query:"Dubai"};

  if(t.includes("marina")) f.search_query="Marina";
  if(t.includes("downtown")) f.search_query="Downtown";
  if(t.includes("dubai")) f.region="Dubai";

  const price=t.match(/(\d+)\s*[-Ùˆ]\s*(\d+)/);
  if(price){
    f.unit_price_from=price[1]*1000000;
    f.unit_price_to=price[2]*1000000;
  }

  const bed=t.match(/(\d)\s*Øº/);
  if(bed) f.unit_bedrooms=bed[1];

  return f;
}

async function fetchProjects(filters){
  const qs=new URLSearchParams({...filters,per_page:5,page:1}).toString();
  const url=`${API_BASE}?${qs}`;

  const r=await fetch(url,{
    headers:{
      "X-API-Key":API_KEY,
      "accept":"application/json"
    }
  });

  const data=await r.json();
  return data.items||[];
}

async function send(){
  const text=input.value.trim();
  if(!text) return;
  input.value="";

  bubble(text,"user");

  const filters=parsePrompt(text);

  bubble(
`ÙÙ‡Ù…Øª Ø·Ù„Ø¨Ùƒ:
ğŸ“ ${filters.region||"Any"}
ğŸ” ${filters.search_query}
ğŸ’° ${filters.unit_price_from||"â€”"} â†’ ${filters.unit_price_to||"â€”"}
ğŸ›ï¸ ${filters.unit_bedrooms||"Any"}
Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...`,"bot");

  const items=await fetchProjects(filters);

  if(!items.length){
    bubble("âŒ Ù…Ø§ Ù„Ù‚ÙŠØª Ù†ØªØ§Ø¦Ø¬ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø¬Ø±Ù‘Ø¨ ØªÙˆØ³Ù‘Ø¹ Ø§Ù„Ø¨Ø­Ø«.","bot");
    return;
  }

  const wrap=document.createElement("div");
  wrap.className="row bot";
  const b=document.createElement("div");
  b.className="bubble";

  const grid=document.createElement("div");
  grid.className="cards";

  items.forEach(it=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <img src="${getImage(it)}">
      <div class="card-body">
        <div class="title">${it.name||"Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</div>
        <div class="meta">${it.developer||""}</div>
        <div class="meta">Ù…Ù† ${it.min_price||"-"} ${it.price_currency||""}</div>
      </div>
    `;
    grid.appendChild(c);
  });

  b.appendChild(grid);
  wrap.appendChild(b);
  chat.appendChild(wrap);
  chat.scrollTop=chat.scrollHeight;
}

document.getElementById("send").onclick=send;
input.addEventListener("keydown",e=>{if(e.key==="Enter")send();});

bubble("Ø£Ù‡Ù„Ù‹Ø§ ğŸ‘‹ Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±ÙŠ ÙˆØ£Ù†Ø§ Ø£Ø¬ÙŠØ¨ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.","bot");
</script>

</body>
</html>
